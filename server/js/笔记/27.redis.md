# redis

1. 设置过期时间，以免进程异常导致锁不能正常释放

2. 保证原子性：在加锁的同时设置过期时间

    因为 Redis 版本在 2.6.12 之前，Set 是不支持 NX 参数的，如果想要完成一个锁，那么需要两条命令：

    ```
    1. setnx Test uuid
    2. expire Test 30
    ```

    即放入 Key 和设置有效期，是分开的两步，理论上会出现 1 刚执行完，程序挂掉，无法保证原子性。

    但是早在 2013 年，也就是 7 年前，Redis 就发布了 2.6.12 版本，并且官网(Set 命令页)，也早早就说明了“SETNX，SETEX，PSETEX 可能在未来的版本中，会弃用并永久删除”。

3. 设置锁的 value 值，当解锁时，先获取 value 判断是否是当前进程加的锁，再去删除，保证加解锁的进程是同一个

    > eg: 若 A 进程执行的时间超出过期时间，B 进程在过期时间之后获取了锁，当 A 进程执行完后，会误删 B 加的锁。

4. finally 代码块执行 3 的操作，由于 get 和 del 非原子操作，还是有进程问题

    > 通过 lua 脚本：lua 脚本能保证原子性
